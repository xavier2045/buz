<template>
  <div class="license-container">
    <!-- 标题部分 -->
    <div class="header" v-if="!showNonCommercialExpiration && !showLicenseExpiration && !showRemixPermission && !showCommercialRemixPermission && !showRevenueShare && !showAttribution && !showAttributionRequired && !showAITraining">
      <h1>添加许可证</h1>
      <p class="subtitle-zh">您最多可向此资产添加5个许可证</p>
    </div>

    <!-- 标签页切换 -->
    <div class="tabs" v-if="!showNonCommercialExpiration && !showLicenseExpiration && !showRemixPermission && !showCommercialRemixPermission && !showRevenueShare && !showAttribution && !showAttributionRequired && !showAITraining">
      <div 
        v-for="(tab, index) in tabs" 
        :key="tab.id"
        :class="['tab', { active: activeTabIndex === index }]"
        @click="setActiveTab(index)"
      >
        {{ tab.label }}
      </div>
    </div>

    <!-- 非商业许可证到期日期页面 -->
    <NonCommercialExpirationPage
      v-if="showNonCommercialExpiration"
      :source-tab="sourceTab"
      @select-expiration="handleExpirationSelect"
      @navigate-back="handleNavigateBack"
    />
    
    <!-- 商业许可证到期日期页面 -->
    <LicenseExpirationPage
      v-if="showLicenseExpiration"
      :source-tab="sourceTab"
      :license-type="currentLicenseType"
      @select-expiration="handleCommercialExpirationSelect"
      @navigate-back="handleNavigateBack"
    />
    
    <!-- 混音许可选择页面 -->
    <RemixPermissionPage
      v-if="showRemixPermission"
      :source-tab="sourceTab"
      @select-remix="handleRemixSelect"
      @navigate-back="handleNavigateBack"
    />
    
    <!-- 商业混音许可选择页面 -->
    <CommercialRemixPermissionPage
      v-if="showCommercialRemixPermission"
      :source-tab="sourceTab"
      :license-type="currentLicenseType"
      :expiration="tempLicenseData.expiration"
      @select-remix="handleCommercialRemixSelect"
      @navigate-back="handleNavigateBack"
    />
    
    <!-- 收入分成选择页面 -->
    <RevenueSharePage
      v-if="showRevenueShare"
      :source-tab="sourceTab"
      :license-type="currentLicenseType"
      :expiration="tempLicenseData.expiration"
      :allow-remix="tempLicenseData.allowRemix"
      @select-revenue-share="handleRevenueShareSelect"
      @navigate-back="handleNavigateBack"
    />
    
    <!-- 注明出处选择页面 -->
    <AttributionPage
      v-if="showAttribution"
      :source-tab="sourceTab"
      :license-type="currentLicenseType"
      :expiration="tempLicenseData.expiration"
      :allow-remix="tempLicenseData.allowRemix"
      :revenue-share="tempLicenseData.revenueShare"
      @select-attribution="handleAttributionPageSelect"
      @navigate-back="handleNavigateBack"
    />
    
    <!-- AI训练选择页面 -->
    <AITrainingPage
      v-if="showAITraining"
      :source-tab="sourceTab"
      @select-ai-training="handleAITrainingSelect"
      @navigate-back="handleNavigateBack"
    />
    
    <!-- 铸造许可证页面 -->
    <MintLicensePage
      v-if="showMintLicensePage"
      :license-type="selectedMintLicense"
      :license-price="licensePrice"
      :revenue-share="revenueShare"
      @navigate-back="handleNavigateBack"
      @mint-complete="handleMintComplete"
    />

    <!-- 预设许可证标签页内容 -->
    <div v-else-if="activeTabIndex === 0" class="license-options">
      <!-- 显示已选择的许可证 -->
      <div class="selected-licenses-header">
        <h3>已选择的许可证: <span class="license-count">{{ selectedLicenses.length }}/5</span></h3>
        <div v-if="assetType" class="asset-type-info">
          当前资产类型: <span class="asset-type-value">{{ getAssetTypeChinese }}</span>
          <div class="asset-type-hint">基于您的资产类型，我们为您推荐以下许可证</div>
        </div>
        
        <div class="selected-licenses-list">
          <div v-if="selectedLicenses.length === 0" class="no-licenses">尚未选择许可证</div>
          <div v-else class="selected-license-tags">
            <span v-for="license in selectedLicenses" :key="license" class="selected-license-tag">
              {{ getLicenseName(license) }}
              <span class="remove-tag" @click.stop="removeLicense(license)">×</span>
            </span>
          </div>
        </div>
      </div>

      <!-- 许可证冲突提示组件 -->
      <LicenseConflictAlert
        v-if="showConflictAlert"
        :is-visible="showConflictAlert"
        :conflicting-licenses="currentConflict.conflictingLicenses"
        :conflict-reason="currentConflict.reason"
        @close="closeConflictAlert"
        class="grid-full-width"
      />

      <!-- 许可证选项卡片 -->
      <div v-for="license in filteredLicenseOptions" 
           :key="license.id"
           class="license-card-wrapper">
        <LicenseCard 
          :license="license"
          :is-selected="selectedLicenses.includes(license.id)"
          :is-recommended="recommendedLicenses.includes(license.id)"
          :uploaded-files="uploadedFiles[license.id] || []"
          @select="selectLicense"
          @file-upload="handleFileUpload"
        />
      </div>
    </div>

    <!-- 自定义许可证标签页内容 -->
    <CustomLicenseTab
      v-else-if="activeTabIndex === 1 && !showNonCommercialExpiration && !showLicenseExpiration && !showCommercialRemixPermission && !showRevenueShare && !showAttribution"
      :selected-licenses="selectedLicenses"
      :expanded-filters="expandedFilters"
      :filter-selections="filterSelections"
      :is-active="activeTabIndex === 1"
      @set-filter="setFilter"
      @toggle-filter="toggleFilter"
      @clear-filter="clearFilter"
      @license-option-conflict="handleOptionConflict"
      @validate-licensing-fee="handleLicensingFeeValidation"
      @validate-file-upload="handleFileUploadValidation"
      @file-upload="handleCustomFileUpload"
    />

    <!-- 许可证助手标签页内容 -->
    <LicenseAssistantTab 
      v-else-if="activeTabIndex === 2 && !showNonCommercialExpiration && !showLicenseExpiration && !showCommercialRemixPermission && !showRevenueShare && !showAttribution"
      @select-license="handleAssistantLicenseSelect"
      @navigate-to-expiration="navigateToExpiration"
      @navigate-to-commercial-expiration="navigateToCommercialExpiration"
      @navigate-to-mint="navigateToMint"
    />
    
    <!-- 请至少选择一个许可证提示 -->
    <div class="license-error" v-if="props.selectedLicenses.length === 0 && !showNonCommercialExpiration && !showLicenseExpiration && !showRemixPermission && !showCommercialRemixPermission && !showRevenueShare && !showAttribution && !showAttributionRequired && !showAITraining">
      <p>请至少选择一个许可选项才能继续</p>
    </div>

    <!-- 底部导航按钮 -->
    <div class="navigation-section" v-if="!showNonCommercialExpiration && !showLicenseExpiration && !showRemixPermission && !showCommercialRemixPermission && !showRevenueShare && !showAttribution && !showAttributionRequired && !showAITraining">
      <NavigationButtons 
        @back="goBack" 
        @next="goNext"
        :next-disabled="!hasValidLicenseSelection"
      />
    </div>

    <!-- 添加选项冲突模态窗口 -->
    <OptionConflictModal
      v-if="showOptionConflictModal"
      :conflict-data="optionConflictData"
      @close="closeOptionConflictModal"
    />

    <!-- 自动生成的许可类型提示 -->
    <div class="auto-license-message" v-if="activeTabIndex === 1 && hasAutoDetectedLicense">
      <div class="license-auto-detected">
        <span>当前选择等同于: <strong>{{ autoDetectedLicenseType }}</strong></span>
      </div>
    </div>

    <!-- 简化上传提示弹框 -->
    <div class="upload-prompt-modal" v-if="showUploadPrompt">
      <div class="upload-prompt-container">
        <div class="modal-content">
          <!-- 标题栏 -->
          <div class="modal-header">
            <h3>需要上传原文件</h3>
            <button class="close-button" @click="closeUploadPrompt">×</button>
          </div>
          
          <!-- 主要内容 -->
          <div class="modal-body">
            <div class="upload-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="icon">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <polyline points="17 8 12 3 7 8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                <line x1="12" y1="3" x2="12" y2="15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></line>
              </svg>
            </div>
            
            <p class="upload-message">商业使用或商业混音使用必须上传原文件</p>
            
            <div class="license-types">
              <div class="license-item">
                <div class="license-bar commercial"></div>
                <span>商业使用</span>
              </div>
              <div class="license-item">
                <div class="license-bar remix"></div>
                <span>商业混音</span>
              </div>
            </div>
          </div>
          
          <!-- 底部按钮 -->
          <div class="modal-footer">
            <button @click="closeUploadPrompt" class="confirm-button">我知道了</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, defineComponent, PropType, onMounted } from 'vue';
import NavigationButtons from '../../common/NavigationButtons.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import LicenseCard from '../license/LicenseCard.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import CustomLicenseTab from '../license/CustomLicenseTab.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import LicenseAssistantTab from '../license/LicenseAssistantTab.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import LicenseConflictAlert from '../license/LicenseConflictAlert.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import NonCommercialExpirationPage from '../license/NonCommercialExpirationPage.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import LicenseExpirationPage from '../license/LicenseExpirationPage.vue';
import OptionConflictModal from '../../modals/OptionConflictModal.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import RemixPermissionPage from '../license/RemixPermissionPage.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import CommercialRemixPermissionPage from '../license/CommercialRemixPermissionPage.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import AttributionRequiredPage from '../license/AttributionRequiredPage.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import AITrainingPage from '../license/AITrainingPage.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import MintLicensePage from '../license/MintLicensePage.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import RevenueSharePage from '../license/RevenueSharePage.vue';
// @ts-ignore - 模块存在但TypeScript找不到类型声明
import AttributionPage from '../license/AttributionPage.vue';
// 导入上传区域组件
import UploadDropArea from '../license/UploadDropArea.vue';

const emit = defineEmits(['navigate-back', 'navigate-next', 'license-update', 'license-conflict', 'license-select', 'navigate-to-commercial-pricing', 'navigate-to-commercial-remix-pricing', 'navigate-to-combined-pricing']);

// 错误提示状态
const showLicenseError = ref(false);
const showValidationError = ref(false);
const validationErrorMessage = ref('请至少选择一个许可选项才能继续');
const licenseFeesValid = ref(true);  // 许可费用验证状态

const props = defineProps({
  selectedLicenses: {
    type: Array as () => string[],
    default: () => []
  },
  assetType: {
    type: String,
    default: ''
  },
  workType: {
    type: String,
    default: ''
  }
});

// 显示非商业许可证到期日期页面的状态
const showNonCommercialExpiration = ref(false);
const currentLicenseType = ref('');

// 显示商业许可证到期日期页面的状态
const showLicenseExpiration = ref(false);

// 显示混音许可选择页面的状态
const showRemixPermission = ref(false);

// 显示商业混音许可选择页面的状态
const showCommercialRemixPermission = ref(false);

// 显示收入分成页面的状态
const showRevenueShare = ref(false);

// 显示注明出处页面的状态
const showAttribution = ref(false);

// 显示归属要求选择页面的状态
const showAttributionRequired = ref(false);

// 显示AI训练选择页面的状态
const showAITraining = ref(false);

// 显示铸造许可证页面的状态
const showMintLicensePage = ref(false);
const selectedMintLicense = ref('');
const licensePrice = ref('');
const revenueShare = ref('0');

// 临时存储许可数据
const tempLicenseData = ref<{
  licenseId: string;
  expiration: string;
  allowRemix?: boolean;
  revenueShare?: string;
  requireAttribution?: boolean;
  aiTraining?: boolean;
}>({
  licenseId: '',
  expiration: ''
});

// 标签页数据
const tabs = [
  { id: 'preset', label: '预设许可证' },
  { id: 'custom', label: '自定义许可证' },
  { id: 'assistant', label: '许可证助手' }
];

// 当前选中的标签页
const activeTabIndex = ref(0);

// 记录展开的过滤器项
interface ExpandedFilters {
  'ai-training': boolean;
  'commercial-use': boolean;
  'attribution': boolean;
  'remixing': boolean;
  'expiration': boolean;
  'licensing-fee': boolean;
  [key: string]: boolean; // 添加索引签名，允许使用字符串索引
}

const expandedFilters = ref<ExpandedFilters>({
  'ai-training': false,
  'commercial-use': false,
  'attribution': false,
  'remixing': false,
  'expiration': false,
  'licensing-fee': false
});

// 过滤器选择状态
interface FilterSelections {
  'ai-training': string | null;
  'commercial-use': string | null;
  'attribution': string | null;
  'remixing': string | null;
  'expiration': string | null;
  'licensing-fee': string | null;
  [key: string]: string | null; // 添加索引签名，允许使用字符串索引
}

const filterSelections = ref<FilterSelections>({
  'ai-training': null,
  'commercial-use': null,
  'attribution': null,
  'remixing': null,
  'expiration': null,
  'licensing-fee': null
});

// 冲突提示状态
const showConflictAlert = ref(false);
const currentConflict = ref<{
  newLicense: string;
  conflictingLicenses: string[];
  reason: string;
}>({
  newLicense: '',
  conflictingLicenses: [],
  reason: ''
});

// 添加选项冲突模态窗口的状态
const showOptionConflictModal = ref(false);
const optionConflictData = ref({
  message: '',
  filterId: '',
  value: ''
});

// 添加上传原文件模态窗口的状态
const showUploadFileModal = ref(false);
const originalFiles = ref<File[]>([]);
const pendingLicenseId = ref('');

// 添加文件上传跟踪状态，修改为支持多文件
const uploadedFiles = ref<Record<string, File[]>>({
  'commercial': [],
  'commercial-remix': [],
  'non-commercial': [],
  'open': []
});

// 自定义许可证文件上传状态
const customLicenseFilesValid = ref(true);

// 添加showUploadArea变量仅为了兼容现有代码
const showUploadArea = ref(false);

// 添加上传文件提示弹框的状态
const showUploadPrompt = ref(false);

// 关闭上传提示弹框
const closeUploadPrompt = () => {
  showUploadPrompt.value = false;
};

// 导航到非商业许可证到期日期页面
const navigateToExpiration = (licenseType: string) => {
  currentLicenseType.value = licenseType;
  // 设置来源标签页，便于返回时导航回正确的页面
  sourceTab.value = tabs[activeTabIndex.value].id;
  showNonCommercialExpiration.value = true;
  // 确保只显示到期日期选择界面，隐藏标签页和其他选项
  activeTabIndex.value = -1; // 设置为无效索引，确保不会显示任何标签页内容
};

// 处理到期日期选择
const handleExpirationSelect = (expirationType: string) => {
  // 处理到期日期选择
  console.log(`选择了到期类型: ${expirationType}, 许可类型: ${currentLicenseType.value}`);
  
  // 保存到期类型到临时数据
  tempLicenseData.value = {
    licenseId: currentLicenseType.value,
    expiration: expirationType
  };
  
  // 导航到混音许可页面
  showNonCommercialExpiration.value = false;
  showRemixPermission.value = true;
};

// 获取基于资产类型和作品类型的推荐许可证
const recommendedLicenses = computed(() => {
  // 根据资产类型返回推荐的许可证ID列表
  const recommendations: Record<string, string[]> = {
    // 视频资产推荐
    'video': ['commercial', 'commercial-remix'],
    // 图片资产推荐
    'image': ['open', 'non-commercial', 'commercial'],
    // 音频资产推荐
    'audio': ['commercial-remix', 'non-commercial'],
    // 文本资产推荐
    'text': ['open', 'non-commercial']
  };
  
  // 返回适合当前资产类型的推荐许可证，如果没有特定推荐则返回所有选项
  return props.assetType && recommendations[props.assetType] 
    ? recommendations[props.assetType] 
    : ['open', 'non-commercial', 'commercial', 'commercial-remix'];
});

// 预设许可证选项
const licenseOptions = [
  {
    id: 'open',
    name: '开放使用',
    description: '免费分发和混音，无限制、无收入要求、无归属要求',
    tagStyle: 'blue',
    tagIcon: 'ai',
    tagText: '限制最少',
    icons: ['document', 'free', 'remix', 'terms']
  },
  {
    id: 'non-commercial',
    name: '非商业混音',
    description: '任何人都可使用您的作品创建非商业项目',
    tagStyle: 'purple',
    tagIcon: '🏆',
    tagText: '为您的作品获得认可',
    icons: ['document', 'free', 'remix', 'terms']
  },
  {
    id: 'commercial',
    name: '商业使用',
    description: '允许他人按照您设定的经济条款使用您的作品',
    tagStyle: 'green',
    tagIcon: '💲',
    tagText: '为您的作品获得报酬',
    icons: ['document', 'paid', 'no-remix', 'terms']
  },
  {
    id: 'commercial-remix',
    name: '商业混音',
    description: '允许他人混音您的作品，同时您获得认可和收益',
    tagStyle: 'red',
    tagIcon: '💰',
    tagText: '获得报酬与认可',
    icons: ['document', 'paid', 'remix', 'terms']
  }
];

// 根据资产类型筛选出可用的许可证选项
const filteredLicenseOptions = computed(() => {
  // 始终显示所有许可证选项，不再根据资产类型筛选
  return licenseOptions;
});

// 切换标签页
const setActiveTab = (index: number) => {
  activeTabIndex.value = index;
  // 切换标签页时关闭冲突提示
  showConflictAlert.value = false;
};

// 切换过滤器项的展开/折叠状态
const toggleFilter = (filterId: string) => {
  if (filterId in expandedFilters.value) {
    expandedFilters.value[filterId] = !expandedFilters.value[filterId];
  }
};

// 设置过滤器选项
const setFilter = (filterId: string, value: string) => {
  if (filterId in filterSelections.value) {
    filterSelections.value[filterId] = value;
  }
};

// 清除过滤器选项
const clearFilter = (filterId: string) => {
  if (filterId in filterSelections.value) {
    filterSelections.value[filterId] = null;
  }
};

// 重置所有展开的过滤器状态为false
const resetExpandedFilters = () => {
  Object.keys(expandedFilters.value).forEach(key => {
    expandedFilters.value[key] = false;
  });
};

// 添加直接打开系统文件选择器的方法
const openFileSelector = (licenseId: string) => {
  pendingLicenseId.value = licenseId;
  
  // 创建文件输入元素
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '*/*';
  fileInput.style.display = 'none';
  fileInput.multiple = true; // 允许多选文件
  
  // 添加文件变更事件处理
  fileInput.onchange = (event) => {
    const input = event.target as HTMLInputElement;
    if (input.files && input.files.length > 0) {
      const filesArray = Array.from(input.files) as File[];
      originalFiles.value = filesArray;
      handleOriginalFileUploaded(filesArray);
    }
  };
  
  // 添加到文档并触发点击
  document.body.appendChild(fileInput);
  fileInput.click();
  
  // 点击后移除元素
  setTimeout(() => {
    document.body.removeChild(fileInput);
  }, 1000);
};

// 修改选择许可证的方法，不再显示底部上传区域
const selectLicense = (licenseId: string) => {
  const licenseConflicts = checkLicenseConflicts(licenseId);
  const currentLicenses = [...props.selectedLicenses];
  
  if (currentLicenses.includes(licenseId)) {
    // 如果已选择，则移除
    const updatedLicenses = currentLicenses.filter(item => item !== licenseId);
    emit('license-update', updatedLicenses);
    // 移除许可证时也关闭冲突提示
    showConflictAlert.value = false;
    // 清除该许可证的上传文件状态
    uploadedFiles.value[licenseId] = [];
  } else {
    // 如果超过了最大选择数量（5个），显示提示
    if (currentLicenses.length >= 5) {
      alert('您最多可以选择5个许可证');
      return;
    }
    
    // 检查冲突
    if (licenseConflicts.hasConflict) {
      // 设置当前冲突数据
      currentConflict.value = {
        newLicense: licenseId,
        conflictingLicenses: licenseConflicts.conflictingLicenses,
        reason: licenseConflicts.reason
      };
      // 显示内联冲突提示
      showConflictAlert.value = true;
      // 同时发送冲突事件给父组件，用于可能的弹窗显示
      emit('license-conflict', licenseId, licenseConflicts.conflictingLicenses, licenseConflicts.reason);
      return;
    }
    
    // 无冲突，添加许可证
    const updatedLicenses = [...currentLicenses, licenseId];
    emit('license-update', updatedLicenses);
    
    // 不再显示底部上传区域，直接完成许可证添加
    
    // 添加成功时关闭冲突提示
    showConflictAlert.value = false;
  }
};

// 检查许可证冲突
const checkLicenseConflicts = (newLicense: string) => {
  const conflicts = {
    hasConflict: false,
    conflictingLicenses: [] as string[],
    reason: ''
  };
  
  // 开放使用与其他所有许可证互斥
  if (newLicense === 'open') {
    // 开放使用与其他所有许可证冲突
    const conflicting = props.selectedLicenses.filter(l => 
      ['commercial', 'commercial-remix', 'non-commercial'].includes(l)
    );
    
    if (conflicting.length > 0) {
      conflicts.hasConflict = true;
      conflicts.conflictingLicenses = conflicting;
      conflicts.reason = '开放使用（完全免费无限制）与其他许可证类型互斥，不能同时选择';
    }
  } 
  // 如果当前已选择了开放使用，则其他许可证都会与之冲突
  else if (props.selectedLicenses.includes('open')) {
    conflicts.hasConflict = true;
    conflicts.conflictingLicenses = ['open'];
    conflicts.reason = '其他许可证类型与开放使用（完全免费无限制）互斥，不能同时选择';
  }
  
  // 根据图片逻辑，商业使用和商业混音可以一起选择，与图片中的组合逻辑一致
  // 删除商业使用和商业混音之间的冲突检查
  
  // 非商业混音可以与商业类许可证组合，与图片中的组合逻辑一致
  // 删除非商业混音与商业许可证之间的冲突检查
  
  return conflicts;
};

// 关闭冲突提示
const closeConflictAlert = () => {
  showConflictAlert.value = false;
};

// 移除许可证
const removeLicense = (license: string) => {
  const updatedLicenses = props.selectedLicenses.filter(item => item !== license);
  emit('license-update', updatedLicenses);
  // 移除许可证时关闭冲突提示
  showConflictAlert.value = false;
};

// 获取许可证名称
const getLicenseName = (license: string) => {
  const licenseNames = {
    'open': '开放使用',
    'non-commercial': '非商业混音',
    'commercial': '商业使用',
    'commercial-remix': '商业混音'
  };
  return (licenseNames as any)[license] || license;
};

// 页面导航
const goBack = () => {
  resetExpandedFilters();
  emit('navigate-back');
};

// 根据自定义选择情况判断是否有有效的许可证
const hasValidLicenseSelection = computed(() => {
  // 如果已经选择了预设许可证，检查商业许可是否上传了文件
  if (hasSelectedLicenses.value) {
    // 检查是否选择了商业使用或商业混音许可证，并且必须上传了文件
    const commercialSelected = props.selectedLicenses.includes('commercial');
    const commercialRemixSelected = props.selectedLicenses.includes('commercial-remix');
    
    if (commercialSelected && !uploadedFiles.value['commercial']) {
      return false; // 选择了商业使用但没有上传文件
    }
    
    if (commercialRemixSelected && !uploadedFiles.value['commercial-remix']) {
      return false; // 选择了商业混音但没有上传文件
    }
    
    return true; // 其他情况通过验证
  }
  
  // 如果在自定义许可证页面，检查是否有有效的自定义选择
  if (activeTabIndex.value === 1) {
    // 只有在选择了商业使用为'yes'时才检查许可费用
    if (filterSelections.value['commercial-use'] === 'yes' && !licenseFeesValid.value) {
      // 更新验证错误信息
      showValidationError.value = true;
      validationErrorMessage.value = '选择商业使用时，必须设置许可费用';
      return false;
    } else if (hasValidCustomSelection.value) {
      // 对于其他情况，只要有选择即可
      showValidationError.value = false;
      return true;
    } else {
      // 没有有效的自定义选择
      return false;
    }
  }
  
  // 其他情况返回false
  return false;
});

// 修改validationMessages计算属性，加入自定义许可证文件验证
const validationMessages = computed(() => {
  const messages = [];
  
  if (props.selectedLicenses.includes('commercial') && !uploadedFiles.value['commercial']) {
    messages.push('商业使用许可证必须上传原文件才能继续');
  }
  
  if (props.selectedLicenses.includes('commercial-remix') && !uploadedFiles.value['commercial-remix']) {
    messages.push('商业混音许可证必须上传原文件才能继续');
  }
  
  // 自定义许可证验证
  if (activeTabIndex.value === 1 && 
      filterSelections.value['commercial-use'] === 'yes' && 
      !customLicenseFilesValid.value) {
    messages.push('自定义商业使用许可证必须上传原文件才能继续');
  }
  
  return messages;
});

// 修改goNext函数，使用弹框替代alert，并修改提示文本
const goNext = () => {
  // 检查文件上传状态
  const commercialSelected = props.selectedLicenses.includes('commercial');
  const commercialRemixSelected = props.selectedLicenses.includes('commercial-remix');
  
  // 检查是否有商业许可证未上传文件
  const needsFileUpload = (commercialSelected && (!uploadedFiles.value['commercial'] || uploadedFiles.value['commercial'].length === 0)) || 
                        (commercialRemixSelected && (!uploadedFiles.value['commercial-remix'] || uploadedFiles.value['commercial-remix'].length === 0));
  
  if (needsFileUpload) {
    // 显示上传提示弹框，但修改提示文本内容
    showUploadPrompt.value = true;
    return;
  }
  
  // 确保已上传的文件会被持久化保存
  persistUploadedFiles();
  
  // 保存当前选择的许可证数据
  
  // 如果是在自定义许可证页面，并且有有效的自定义选择
  if (activeTabIndex.value === 1 && hasValidCustomSelection.value) {
    // 将自定义选择转换为预设许可证
    addAutoDetectedLicense();
    
    // 等待许可证更新后再导航
    setTimeout(() => {
      navigateBasedOnLicenses();
    }, 100);
  } else {
    // 立即导航
    navigateBasedOnLicenses();
  }
};

// 确保上传的文件被持久化保存
const persistUploadedFiles = () => {
  // 遍历所有许可证类型
  Object.keys(uploadedFiles.value).forEach(licenseId => {
    const files = uploadedFiles.value[licenseId];
    if (files && files.length > 0) {
      try {
        // 保存到window对象
        if (typeof window !== 'undefined') {
          // @ts-ignore
          window._uploadedLicenseFiles = window._uploadedLicenseFiles || {};
          // @ts-ignore
          window._uploadedLicenseFiles[licenseId] = files;
          
          // 同时将元数据保存到localStorage
          const fileInfos = files.map(file => ({
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified,
          }));
          localStorage.setItem(`uploaded_files_${licenseId}`, JSON.stringify(fileInfos));
          
          console.log(`持久化保存 ${licenseId} 的文件状态，共 ${files.length} 个文件`);
        }
      } catch (e) {
        console.error(`持久化保存 ${licenseId} 的文件状态失败:`, e);
      }
    }
  });
};

// 根据选择的许可证决定导航目标
const navigateBasedOnLicenses = () => {
  emit('license-update', props.selectedLicenses);
  
  // 检查是否需要单独定价
  if (props.selectedLicenses.includes('commercial') && props.selectedLicenses.includes('commercial-remix')) {
    // 如果同时选择了商业和商业混音，导航到组合定价页面
    emit('navigate-to-combined-pricing');
  } else if (props.selectedLicenses.includes('commercial')) {
    // 如果只选择了商业，导航到商业定价页面
    emit('navigate-to-commercial-pricing');
  } else if (props.selectedLicenses.includes('commercial-remix')) {
    // 如果只选择了商业混音，导航到商业混音定价页面
    emit('navigate-to-commercial-remix-pricing');
  } else {
    // 否则直接进入AI权限设置
    emit('navigate-next');
  }
};

// 获取资产类型中文名称
const getAssetTypeChinese = computed(() => {
  const assetTypeNames: Record<string, string> = {
    'video': '视频',
    'image': '图片',
    'audio': '音频',
    'text': '文档'
  };
  return assetTypeNames[props.assetType] || props.assetType;
});

// 处理选项冲突
const handleOptionConflict = (conflictData: any) => {
  optionConflictData.value = conflictData;
  showOptionConflictModal.value = true;
};

// 关闭选项冲突模态窗口
const closeOptionConflictModal = () => {
  showOptionConflictModal.value = false;
};

// 处理原文件上传完成
const handleOriginalFileUploaded = (files: File[]) => {
  // 保存上传的文件
  originalFiles.value = files;
  console.log('上传的原文件:', files.length > 0 ? files[0].name : '无文件', '等', files.length, '个文件');
  
  // 如果有待处理的许可证ID，保存文件状态
  if (pendingLicenseId.value) {
    const licenseId = pendingLicenseId.value;
    
    // 保存上传的文件到对应的许可证
    uploadedFiles.value[licenseId] = files;
    
    // 发送选择事件
    emit('license-select', licenseId);
    
    // 重置变量
    pendingLicenseId.value = '';
    
    // 关闭上传区域
    showUploadArea.value = false;
    
    // 关闭冲突提示
    showConflictAlert.value = false;
  }
};

// 从许可证助手标签页导航到非商业许可证到期日期页面
const handleAssistantLicenseSelect = (licenseType: string) => {
  console.log(`从许可证助手选择了许可证: ${licenseType}`);
  // 处理许可证助手选择的许可证
  
  // 如果是商业许可证，则不处理，由LicenseAssistantTab自己处理
};

// 处理铸造许可证完成
const handleMintComplete = (data: { licenseType: string, mintPrice: string }) => {
  console.log(`铸造许可证完成: ${data.licenseType}, 价格: ${data.mintPrice}`);
  
  // 将许可证添加到选中列表
  const updatedLicenses = [...props.selectedLicenses, data.licenseType];
  
  // 发出更新许可证事件
  emit('license-update', updatedLicenses);
  
  // 返回主页面
  showMintLicensePage.value = false;
};

// 从许可证助手导航到铸造页面
const navigateToMint = (licenseType: string) => {
  selectedMintLicense.value = licenseType;
  
  // 如果是商业许可证，设置相应的价格信息
  if (licenseType === 'commercial' || licenseType === 'commercial-remix') {
    // 这里可以设置默认价格或从其他地方获取
    licensePrice.value = '';
    revenueShare.value = licenseType === 'commercial-remix' ? '10' : '0';
  }
  
  // 显示铸造页面，隐藏其他页面
  showMintLicensePage.value = true;
  activeTabIndex.value = -1; // 确保不显示标签页内容
};

// 处理导航返回
const handleNavigateBack = (source: string = '') => {
  showNonCommercialExpiration.value = false;
  showLicenseExpiration.value = false;
  showRemixPermission.value = false;
  showCommercialRemixPermission.value = false;
  showRevenueShare.value = false;
  showAttribution.value = false;
  showAttributionRequired.value = false;
  showAITraining.value = false;
  
  // 如果传入了来源参数，优先使用它
  const tabToReturn = source || sourceTab.value;
  
  if (tabToReturn === 'preset') {
    resetExpandedFilters();
    activeTabIndex.value = 0;
  } else if (tabToReturn === 'custom') {
    activeTabIndex.value = 1;
  } else if (tabToReturn === 'assistant') {
    activeTabIndex.value = 2;
  } else {
    // 默认返回预设标签页
    activeTabIndex.value = 0;
  }
};

// 设置源标签页
const sourceTab = ref('preset');

// 处理混音许可选择
const handleRemixSelect = (remixType: string) => {
  console.log('从混音许可收到选择:', remixType);
  
  // 更新临时数据，添加混音选项
  tempLicenseData.value.allowRemix = remixType === 'yes';
  
  // 导航到归属要求页面
  showRemixPermission.value = false;
  showAttributionRequired.value = true;
};

// 处理归属要求选择
const handleAttributionSelect = (attributionType: string) => {
  console.log('从归属要求收到选择:', attributionType);
  
  // 更新临时数据，添加归属要求选项
  tempLicenseData.value.requireAttribution = attributionType === 'yes';
  
  // 导航到AI训练页面
  showAttributionRequired.value = false;
  showAITraining.value = true;
};

// 处理AI训练选择
const handleAITrainingSelect = (aiTrainingType: string) => {
  console.log('从AI训练收到选择:', aiTrainingType);
  
  // 更新临时数据，添加AI训练选项
  tempLicenseData.value.aiTraining = aiTrainingType === 'yes';
  
  // 获取许可证ID
  const licenseId = tempLicenseData.value.licenseId;
  
  // 检查许可证冲突
  const licenseConflicts = checkLicenseConflicts(licenseId);
  
  if (licenseConflicts.hasConflict) {
    // 显示冲突信息
    currentConflict.value = {
      newLicense: licenseId,
      conflictingLicenses: licenseConflicts.conflictingLicenses,
      reason: licenseConflicts.reason
    };
    showConflictAlert.value = true;
    emit('license-conflict', licenseId, licenseConflicts.conflictingLicenses, licenseConflicts.reason);
  } else {
    // 无冲突，添加许可证
    const currentLicenses = [...props.selectedLicenses];
    if (!currentLicenses.includes(licenseId)) {
      const updatedLicenses = [...currentLicenses, licenseId];
      emit('license-update', updatedLicenses);
      
      // 如果是商业许可证，发送选择事件
      if (licenseId === 'commercial' || licenseId === 'commercial-remix') {
        emit('license-select', licenseId);
      }
    }
  }
  
  // 返回到源标签页
  showAITraining.value = false;
  handleNavigateBack(sourceTab.value);
};

// 自动检测的许可证类型
const autoDetectedLicenseType = computed(() => {
  // 只有当有基本的自定义选择时才进行匹配
  if (!hasValidCustomSelection.value) {
    return '开放使用'; // 默认返回开放使用
  }

  // 根据自定义设置自动匹配许可证类型
  const fs = filterSelections.value;
  
  // 优先匹配完全匹配的情况
  
  // 开放使用：允许商用且不需要署名
  if (fs['commercial-use'] === 'yes' && fs['attribution'] === 'no') {
    return '开放使用';
  }
  
  // 非商业混音：不允许商用、需要署名、允许混音
  if (fs['commercial-use'] === 'no' && fs['attribution'] === 'yes' && fs['remixing'] === 'yes') {
    return '非商业混音';
  }
  
  // 商业使用：允许商用、需要署名、不允许混音
  if (fs['commercial-use'] === 'yes' && fs['attribution'] === 'yes' && fs['remixing'] === 'no') {
    return '商业使用';
  }
  
  // 商业混音：允许商用、需要署名、允许混音
  if (fs['commercial-use'] === 'yes' && fs['attribution'] === 'yes' && fs['remixing'] === 'yes') {
    return '商业混音';
  }

  // 当无法完全匹配时，根据最重要特征匹配
  
  // 商业用途是最主要的判断标准
  if (fs['commercial-use'] === 'yes') {
    // 商业用途 + 允许混音 = 商业混音，否则 = 商业使用
    return fs['remixing'] === 'yes' ? '商业混音' : '商业使用';
  } else if (fs['commercial-use'] === 'no') {
    // 非商业用途 + 允许混音 = 非商业混音，否则 = 开放使用
    return fs['remixing'] === 'yes' ? '非商业混音' : '开放使用';
  }
  
  // 如果商业用途未设置，则根据混音和署名判断
  if (fs['remixing'] === 'yes') {
    return fs['attribution'] === 'yes' ? '非商业混音' : '开放使用';
  } else if (fs['remixing'] === 'no') {
    return fs['attribution'] === 'yes' ? '商业使用' : '开放使用';
  }
  
  // 最后的默认值是开放使用
  return '开放使用';
});

// 自动检测的许可证状态
const hasAutoDetectedLicense = computed(() => {
  // 只要有基本的自定义选择，就应该显示自动检测到的许可证类型
  return hasValidCustomSelection.value;
});

// 判断是否有已选择的许可证
const hasSelectedLicenses = computed(() => {
  return props.selectedLicenses.length > 0;
});

// 判断是否有有效的自定义选择
const hasValidCustomSelection = computed(() => {
  // 如果自定义选择页面不是当前页面，直接返回false
  if (activeTabIndex.value !== 1) return false;
  
  // 检查是否至少设置了商业使用、署名和混音这三个基本选项
  const fs = filterSelections.value;
  return fs['commercial-use'] !== null && 
         fs['attribution'] !== null && 
         fs['remixing'] !== null;
});

// 将自动检测的许可证添加到选择列表
const addAutoDetectedLicense = () => {
  // 将自动检测的许可证类型转换为许可证ID
  let licenseId = '';
  switch (autoDetectedLicenseType.value) {
    case '开放使用':
      licenseId = 'open';
      break;
    case '非商业混音':
      licenseId = 'non-commercial';
      break;
    case '商业使用':
      licenseId = 'commercial';
      break;
    case '商业混音':
      licenseId = 'commercial-remix';
      break;
    default:
      // 兜底方案，如果无法匹配则默认为开放使用
      licenseId = 'open';
      break;
  }
  
  // 只有有效的许可证ID才添加
  if (licenseId && !props.selectedLicenses.includes(licenseId)) {
    const updatedLicenses = [...props.selectedLicenses, licenseId];
    emit('license-update', updatedLicenses);
    
    console.log(`自动添加许可证: ${licenseId} (${autoDetectedLicenseType.value})`);
  }
};

// 处理许可证费用验证
const handleLicensingFeeValidation = (valid: boolean) => {
  licenseFeesValid.value = valid;
  
  // 如果是商业使用，根据许可费用验证状态更新错误提示
  if (filterSelections.value['commercial-use'] === 'yes') {
    if (valid) {
      // 许可费用有效，隐藏错误提示
      showValidationError.value = false;
    } else {
      // 许可费用无效，显示错误提示
      showValidationError.value = true;
      validationErrorMessage.value = '选择商业使用时，必须设置许可费用';
    }
  }
};

// 处理自定义许可证页面的文件上传
const handleCustomFileUpload = (fileData: { isCommercial: boolean, file: File }) => {
  console.log('收到自定义许可证文件上传:', fileData);
  // 根据商业/非商业使用情况，更新文件状态
  if (fileData.isCommercial) {
    customLicenseFilesValid.value = true;
  }
};

// 处理文件上传验证
const handleFileUploadValidation = (isValid: boolean) => {
  customLicenseFilesValid.value = isValid;
};

// 处理文件上传
const handleFileUpload = (fileData: { licenseId: string, file: File | File[] }) => {
  const { licenseId, file } = fileData;
  
  // 确保文件是数组格式
  const files = Array.isArray(file) ? file : [file];
  
  // 保存上传的文件到对应的许可证
  uploadedFiles.value[licenseId] = files;
  
  // 文件上传后发送选择事件
  emit('license-select', licenseId);
  
  // 持久化保存上传的文件信息到localStorage，便于在不同页面间保存文件状态
  try {
    // 创建可以序列化的文件信息对象
    const fileInfos = files.map(file => ({
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified,
      // 不存储文件内容，只保存文件元数据
    }));
    
    // 保存到localStorage
    localStorage.setItem(`uploaded_files_${licenseId}`, JSON.stringify(fileInfos));
    
    // 在Window对象上也保存文件引用，以便在整个应用程序生命周期内保留
    if (typeof window !== 'undefined') {
      // @ts-ignore - 添加到Window对象
      window._uploadedLicenseFiles = window._uploadedLicenseFiles || {};
      // @ts-ignore
      window._uploadedLicenseFiles[licenseId] = files;
    }
    
    console.log(`已保存 ${licenseId} 的文件状态，共 ${files.length} 个文件`);
  } catch (e) {
    console.error('保存文件状态失败:', e);
  }
};

// 添加页面加载时恢复文件状态的逻辑
onMounted(() => {
  // 尝试从localStorage或window对象恢复上传的文件
  restoreUploadedFiles();
});

// 恢复之前上传的文件
const restoreUploadedFiles = () => {
  // 许可证类型列表
  const licenseTypes = ['open', 'non-commercial', 'commercial', 'commercial-remix'];
  
  try {
    licenseTypes.forEach(licenseId => {
      // 首先尝试从window对象恢复实际文件
      // @ts-ignore
      const windowFiles = typeof window !== 'undefined' && window._uploadedLicenseFiles && window._uploadedLicenseFiles[licenseId];
      if (windowFiles && windowFiles.length > 0) {
        uploadedFiles.value[licenseId] = windowFiles;
        console.log(`从window对象恢复 ${licenseId} 的文件状态，共 ${windowFiles.length} 个文件`);
        return;
      }
      
      // 如果window对象中没有，则尝试从localStorage恢复文件信息（但无法恢复实际文件内容）
      const storedFileInfo = typeof localStorage !== 'undefined' && localStorage.getItem(`uploaded_files_${licenseId}`);
      if (storedFileInfo) {
        const fileInfos = JSON.parse(storedFileInfo);
        console.log(`找到 ${licenseId} 的文件信息，共 ${fileInfos.length} 个文件，但无法恢复实际文件内容`);
        // 这里只能恢复文件元数据，无法恢复实际文件内容
        // 如果文件内容不可用，可以选择提示用户重新上传
      }
    });
  } catch (e) {
    console.error('恢复文件状态失败:', e);
  }
};

// 导航到商业许可证到期日期页面
const navigateToCommercialExpiration = (licenseType: string) => {
  currentLicenseType.value = licenseType;
  // 设置来源标签页，便于返回时导航回正确的页面
  sourceTab.value = tabs[activeTabIndex.value].id;
  showLicenseExpiration.value = true;
  // 确保只显示到期日期选择界面，隐藏标签页和其他选项
  activeTabIndex.value = -1; // 设置为无效索引，确保不会显示任何标签页内容
};

// 处理商业许可证到期日期选择
const handleCommercialExpirationSelect = (expirationType: string) => {
  // 处理到期日期选择
  console.log(`选择了商业许可到期类型: ${expirationType}, 许可类型: ${currentLicenseType.value}`);
  
  // 保存到期类型到临时数据
  tempLicenseData.value = {
    licenseId: currentLicenseType.value,
    expiration: expirationType
  };
  
  // 导航到商业混音许可页面
  showLicenseExpiration.value = false;
  showCommercialRemixPermission.value = true;
};

// 处理商业混音许可选择
const handleCommercialRemixSelect = (remixType: string) => {
  console.log('从商业混音许可收到选择:', remixType);
  
  // 更新临时数据，添加混音选项
  tempLicenseData.value.allowRemix = remixType === 'yes';
  
  // 如果选择了是，导航到收入分成页面，否则直接到注明出处页面
  showCommercialRemixPermission.value = false;
  
  if (remixType === 'yes') {
    showRevenueShare.value = true;
  } else {
    // 如果选择不允许混音，跳过收入分成步骤
    showAttribution.value = true;
  }
};

// 处理收入分成选择
const handleRevenueShareSelect = (revenueShare: string) => {
  console.log('从收入分成收到选择:', revenueShare);
  
  // 更新临时数据，添加收入分成选项
  tempLicenseData.value.revenueShare = revenueShare;
  
  // 导航到注明出处页面
  showRevenueShare.value = false;
  showAttribution.value = true;
};

// 处理注明出处选择
const handleAttributionPageSelect = (attributionType: string) => {
  console.log('从注明出处收到选择:', attributionType);
  
  // 更新临时数据，添加注明出处选项
  tempLicenseData.value.requireAttribution = attributionType === 'yes';
  
  // 导航到归属要求页面
  showAttribution.value = false;
  showAttributionRequired.value = true;
};
</script>

<style scoped>
/* 保持现有样式不变 */
.license-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 40px 20px;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

/* 修改虚线上传区域的样式，让其在适当位置显示 */
.upload-drop-area {
  border: 2px dashed rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 30px 20px;
  margin: 20px auto;
  width: 100%;
  max-width: 500px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 15px;
  background-color: rgba(0, 0, 0, 0.15);
  position: relative; /* 添加相对定位，用于放置关闭按钮 */
  z-index: 10; /* 确保上传区域在其他元素之上 */
}

.upload-drop-area:hover {
  background-color: rgba(0, 0, 0, 0.25);
  border-color: rgba(255, 255, 255, 0.5);
}

.upload-drop-area.drag-active {
  background-color: rgba(0, 0, 0, 0.3);
  border-color: rgba(255, 255, 255, 0.6);
}

/* 删除强制上传的高亮边框 */
.upload-drop-area.mandatory {
  border-color: rgba(255, 255, 255, 0.3);
}

.upload-drop-area .upload-icon {
  color: rgba(255, 255, 255, 0.6);
  margin-bottom: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.upload-drop-area .upload-icon svg {
  width: 40px;
  height: 40px;
}

.upload-drop-area .upload-text {
  color: rgba(255, 255, 255, 0.8);
  font-size: 15px;
}

.upload-drop-area .upload-description {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.5);
  margin-top: 5px;
}

.header {
  text-align: center;
  margin-bottom: 30px;
}

.header h1 {
  font-size: 32px;
  margin-bottom: 8px;
  color: #ffffff;
}

.subtitle-zh {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.7);
}

.tabs {
  display: flex;
  width: 100%;
  max-width: 600px;
  margin-bottom: 40px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  overflow: hidden;
}

.tab {
  flex: 1;
  padding: 15px 10px;
  text-align: center;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
}

.tab.active {
  background: rgba(255, 255, 255, 0.25);
  color: white;
  font-weight: 500;
}

.tab:hover:not(.active) {
  background: rgba(255, 255, 255, 0.15);
}

.license-options {
  width: 100%;
  max-width: 900px;
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 30px;
  align-items: start; /* 确保每个卡片从顶部对齐 */
  grid-auto-rows: min-content; /* 让每行高度自适应内容 */
}

/* 确保网格中的项目保持独立 */
.license-card-wrapper {
  display: flex;
  flex-direction: column;
  height: auto;
  position: relative;
  break-inside: avoid;
  contain: layout; /* 确保布局隔离 */
}

/* 确保卡片内部的上传区域不会溢出影响布局 */
.file-upload-container {
  margin-top: 10px;
  animation: slideDown 0.3s ease forwards;
  max-height: 300px; /* 设置最大高度，防止内容过多时影响布局 */
  overflow: hidden;
  width: 100%;
  border-radius: 8px;
}

.grid-full-width {
  grid-column: 1 / -1;
  margin-bottom: 10px;
}

.selected-licenses-header {
  grid-column: 1 / -1;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 10px;
}

.selected-licenses-header h3 {
  font-size: 16px;
  margin-bottom: 12px;
  font-weight: 500;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: rgba(255, 255, 255, 0.9);
}

.license-count {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.7);
}

.no-licenses {
  color: rgba(255, 255, 255, 0.5);
  font-style: italic;
  font-size: 14px;
}

.selected-license-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.selected-license-tag {
  background: rgba(255, 255, 255, 0.2);
  padding: 6px 12px;
  border-radius: 30px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.remove-tag {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.remove-tag:hover {
  background: rgba(255, 0, 0, 0.5);
}

@media (max-width: 768px) {
  .license-options {
    grid-template-columns: 1fr;
  }
}

/* 添加导航和错误信息的样式 */
.navigation-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  margin-top: 30px;
}

.license-error-message {
  color: #ff4757;
  background-color: rgba(255, 71, 87, 0.1);
  border: 1px solid rgba(255, 71, 87, 0.3);
  border-radius: 6px;
  padding: 10px 15px;
  font-size: 14px;
  margin-bottom: 15px;
  text-align: center;
  width: 100%;
  max-width: 500px;
  animation: pulse 2s infinite;
}

/* 许可证验证错误的样式 */
.license-validation-error {
  display: none; /* 隐藏验证错误提示 */
}

.validation-message {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #e74c3c;
  font-weight: 500;
}

.warning-icon {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
  stroke: #e74c3c;
}

/* 上传按钮样式 */
.upload-now-btn {
  display: none; /* 隐藏上传按钮 */
}

/* 删除底部上传区域样式 */
.upload-area-container {
  display: none; /* 隐藏上传区域容器 */
}

/* 为主上传区域添加容器样式 */
.upload-area-container {
  width: 100%;
  position: relative;
  margin: 20px 0;
  display: flex;
  justify-content: center;
}

/* 特定许可证样式 */
.license-open {
  background: rgba(30, 30, 35, 0.7);
}

.license-non-commercial {
  background: rgba(30, 30, 35, 0.7);
}

.license-commercial {
  background: rgba(30, 30, 35, 0.7);
}

.license-commercial-remix {
}

/* 简化的上传提示弹框样式 */
.upload-prompt-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.75);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
  backdrop-filter: blur(5px);
}

.upload-prompt-container {
  width: 90%;
  max-width: 400px;
}

.modal-content {
  background-color: #1e1e22;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background-color: #272730;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 500;
  color: white;
}

.close-button {
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 20px;
  cursor: pointer;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.close-button:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.modal-body {
  padding: 25px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.upload-icon {
  width: 56px;
  height: 56px;
  background-color: rgba(45, 212, 191, 0.1);
  color: rgb(45, 212, 191);
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.upload-icon .icon {
  width: 28px;
  height: 28px;
}

.upload-message {
  color: rgba(255, 255, 255, 0.9);
  text-align: center;
  font-size: 15px;
  line-height: 1.5;
  margin: 0;
}

.license-types {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background-color: rgba(0, 0, 0, 0.2);
  padding: 16px;
  border-radius: 10px;
}

.license-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.license-bar {
  height: 8px;
  width: 100px;
  border-radius: 4px;
}

.license-bar.commercial {
  background-color: rgb(45, 212, 191);
}

.license-bar.remix {
  background-color: rgb(34, 211, 238);
}

.license-item span {
  color: rgba(255, 255, 255, 0.85);
  font-size: 14px;
}

.modal-footer {
  padding: 16px 20px;
  display: flex;
  justify-content: flex-end;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.confirm-button {
  padding: 8px 20px;
  background-color: rgb(45, 212, 191);
  color: #0f172a;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.confirm-button:hover {
  background-color: rgb(20, 184, 166);
  transform: translateY(-2px);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style> 